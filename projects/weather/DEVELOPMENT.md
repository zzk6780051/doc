# å¤©æ°”é€šçŸ¥è„šæœ¬å¼€å‘æ–‡æ¡£

## é¡¹ç›®æ¶æ„

### æ ¸å¿ƒæ¨¡å—

```
weather.py
â”œâ”€â”€ é…ç½®ç®¡ç† (get_config)
â”œâ”€â”€ å¤©æ°”æ•°æ®è·å– (get_weather_all)
â”œâ”€â”€ æ¶ˆæ¯æ ¼å¼åŒ– (format_weather_message)
â”œâ”€â”€ é€šçŸ¥å‘é€æ¨¡å—
â”‚   â”œâ”€â”€ Telegramé€šçŸ¥ (send_telegram_message)
â”‚   â”œâ”€â”€ ä¼ä¸šå¾®ä¿¡é€šçŸ¥ (send_wechat_message)
â”‚   â””â”€â”€ GitHubé€šçŸ¥ (update_github_notification)
â””â”€â”€ è¿è¡Œå…¥å£
    â”œâ”€â”€ ä¸»å‡½æ•° (main)
    â””â”€â”€ é’é¾™æ¨¡å¼ (ql_weather)
```

## æ ¸å¿ƒå‡½æ•°è¯¦è§£

### é…ç½®ç®¡ç†

```python
def get_config():
    """ä»ç¯å¢ƒå˜é‡è·å–æ‰€æœ‰é…ç½®"""
    # è¿”å›åŒ…å«æ‰€æœ‰é…ç½®çš„å­—å…¸
```

### å¤©æ°”æ•°æ®è·å–

```python
def get_weather_all(location_id, config):
    """ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å¤©æ°”ä¿¡æ¯
    åŒ…æ‹¬ï¼šå®æ—¶å¤©æ°”ã€ç©ºæ°”è´¨é‡ã€3å¤©é¢„æŠ¥
    """
```

### æ¶ˆæ¯æ ¼å¼åŒ–

```python
def format_weather_message(data, city_name, format_type="html"):
    """å°†å¤©æ°”æ•°æ®æ ¼å¼åŒ–ä¸ºå¯è¯»æ¶ˆæ¯
    æ”¯æŒHTMLæ ¼å¼ï¼ˆTelegramï¼‰å’Œçº¯æ–‡æœ¬æ ¼å¼ï¼ˆä¼ä¸šå¾®ä¿¡ï¼‰
    """
```

### é€šçŸ¥å‘é€

```python
def send_telegram_message(message, config):
    """å‘é€HTMLæ ¼å¼æ¶ˆæ¯åˆ°Telegram"""

def send_wechat_message(message, config):
    """å‘é€çº¯æ–‡æœ¬æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡"""

def update_github_notification(weather_message, config):
    """æ›´æ–°GitHubä»“åº“ä¸­çš„é€šçŸ¥æ–‡ä»¶"""
```

## APIæ¥å£è¯´æ˜

### å’Œé£å¤©æ°”API

- **å®æ—¶å¤©æ°”**: `/v7/weather/now`
- **ç©ºæ°”è´¨é‡**: `/v7/air/now` 
- **3å¤©é¢„æŠ¥**: `/v7/weather/3d`

### Telegram Bot API

- **å‘é€æ¶ˆæ¯**: `https://api.telegram.org/bot{token}/sendMessage`

### ä¼ä¸šå¾®ä¿¡æœºå™¨äºº

- **Webhookå‘é€**: é…ç½®çš„Webhook URL

### GitHub API

- **è·å–æ–‡ä»¶**: `GET /repos/{owner}/{repo}/contents/{path}`
- **æ›´æ–°æ–‡ä»¶**: `PUT /repos/{owner}/{repo}/contents/{path}`

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„é€šçŸ¥æ¸ é“

1. åœ¨é…ç½®å‡½æ•°ä¸­æ·»åŠ æ–°çš„ç¯å¢ƒå˜é‡
2. åˆ›å»ºæ–°çš„å‘é€å‡½æ•°
3. åœ¨ä¸»å‡½æ•°ä¸­è°ƒç”¨æ–°çš„å‘é€å‡½æ•°

ç¤ºä¾‹ï¼šæ·»åŠ é’‰é’‰æœºå™¨äººé€šçŸ¥

```python
def send_dingtalk_message(message, config):
    """å‘é€æ¶ˆæ¯åˆ°é’‰é’‰æœºå™¨äºº"""
    if not config['dingtalk']['webhook']:
        return False
    
    payload = {
        "msgtype": "text",
        "text": {
            "content": message
        }
    }
    # å®ç°å‘é€é€»è¾‘
```

### æ·»åŠ æ–°çš„å¤©æ°”ä¿¡æ¯

1. åœ¨`get_weather_all`å‡½æ•°ä¸­æ·»åŠ æ–°çš„APIè°ƒç”¨
2. åœ¨`format_weather_message`ä¸­æ·»åŠ æ ¼å¼åŒ–é€»è¾‘

### è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼

ä¿®æ”¹`format_weather_message`å‡½æ•°æ¥æ”¹å˜æ¶ˆæ¯çš„æ˜¾ç¤ºæ ·å¼ï¼š

```python
# è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿
custom_template = [
    f"ğŸ“ {city_name}",
    f"ğŸŒ¡ï¸ å½“å‰æ¸©åº¦: {temp}Â°C",
    # ... æ›´å¤šè‡ªå®šä¹‰å­—æ®µ
]
```

## é”™è¯¯å¤„ç†

é¡¹ç›®åŒ…å«å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

- APIè¯·æ±‚è¶…æ—¶å¤„ç†
- é…ç½®ç¼ºå¤±æ£€æŸ¥
- ç½‘ç»œå¼‚å¸¸æ•è·
- å„å¹³å°è¿”å›çŠ¶æ€éªŒè¯

## è°ƒè¯•

### æœ¬åœ°è°ƒè¯•

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
DEBUG=1 python3 weather.py

# æµ‹è¯•ç‰¹å®šåŠŸèƒ½
python3 -c "from weather import get_weather_all; print(get_weather_all('101010100', get_config()))"
```

### ç¯å¢ƒå˜é‡éªŒè¯

```python
# åœ¨ä»£ç ä¸­æ·»åŠ é…ç½®éªŒè¯
required_vars = ['WEATHER_API_KEY', 'WEATHER_API_HOST']
missing_vars = [var for var in required_vars if not os.environ.get(var)]
if missing_vars:
    print(f"ç¼ºå°‘å¿…éœ€ç¯å¢ƒå˜é‡: {missing_vars}")
```

## æ€§èƒ½ä¼˜åŒ–

1. **è¯·æ±‚åˆå¹¶**: ä½¿ç”¨å•ä¸ªå‡½æ•°è·å–æ‰€æœ‰å¤©æ°”æ•°æ®
2. **è¶…æ—¶è®¾ç½®**: æ‰€æœ‰ç½‘ç»œè¯·æ±‚è®¾ç½®è¶…æ—¶æ—¶é—´
3. **é”™è¯¯é‡è¯•**: å¯æ·»åŠ é‡è¯•æœºåˆ¶æé«˜ç¨³å®šæ€§
4. **ç¼“å­˜æœºåˆ¶**: å¯¹ä¸å¸¸å˜çš„æ•°æ®æ·»åŠ ç¼“å­˜

## å®‰å…¨è€ƒè™‘

- æ‰€æœ‰æ•æ„Ÿä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†
- GitHub Tokenä»…éœ€repoæƒé™
- APIè¯·æ±‚ä½¿ç”¨HTTPSåŠ å¯†
- è¾“å…¥æ•°æ®éªŒè¯å’Œè½¬ä¹‰

## éƒ¨ç½²æ³¨æ„äº‹é¡¹

### é’é¾™é¢æ¿
- ç¡®ä¿Pythonç‰ˆæœ¬å…¼å®¹
- è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„æƒé™
- é…ç½®åˆé€‚çš„å®šæ—¶ä»»åŠ¡é—´éš”

### GitHub Actions
- Secretsé…ç½®å¤§å°å†™æ•æ„Ÿ
- æ³¨æ„APIè°ƒç”¨é¢‘ç‡é™åˆ¶
- å·¥ä½œæµè¶…æ—¶æ—¶é—´è®¾ç½®

## å¸¸è§é—®é¢˜æ’æŸ¥

1. **å¤©æ°”æ•°æ®è·å–å¤±è´¥**
   - æ£€æŸ¥APIå¯†é’¥å’Œä¸»æœºé…ç½®
   - éªŒè¯åŸå¸‚IDæ ¼å¼

2. **é€šçŸ¥å‘é€å¤±è´¥**
   - æ£€æŸ¥å„å¹³å°Token/Webhooké…ç½®
   - éªŒè¯ç½‘ç»œè¿é€šæ€§

3. **GitHubæ›´æ–°å¤±è´¥**
   - æ£€æŸ¥Tokenæƒé™
   - éªŒè¯ä»“åº“æ–‡ä»¶è·¯å¾„

#