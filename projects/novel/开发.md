# 开发文档

## 项目概述

小说章节分割工具是一个基于Python的文本处理工具，使用面向对象设计，具备高可扩展性和可维护性。

## 项目结构

```
├── .github/
 │   ├── scripts/
 │   │     └── fenli.py          # 核心分割脚本
 │   └── workflows/
 │         └── split-novels.yml  # GitHub Actions 工作流配置
 ├── 小说名/          # 每本小说分割后的章节文件夹
 │     ├── 第1章.txt
 │     ├── 第2章.txt
 │     ├── metadata.txt
 │     └── split_stats.txt
 ├── already/         # 已处理完成的小说原文件
 └── README.md
```

## 核心架构

### EnhancedNovelSplitter 类

主要功能类，包含以下核心方法：

#### 初始化方法
```python
def __init__(self, log_file: Optional[str] = None)
```
- 初始化章节识别模式
- 设置日志系统
- 初始化统计信息

#### 核心方法
- `detect_encoding()` - 文件编码检测
- `detect_chapter_pattern()` - 章节模式识别
- `extract_metadata()` - 元数据提取
- `split_novel()` - 主要分割逻辑
- `batch_process_with_progress()` - 批量处理

### 章节识别模式

工具预定义了多种章节识别正则表达式：

```python
self.chapter_patterns = [
    # 中文章节格式
    r'^## 第[零一二三四五六七八九十百千两万千亿\d]+章[\s\S]*$',
    r'^第[零一二三四五六七八九十百千两万千亿\d]+章[\s\S]*$',
    # 英文章节格式
    r'^Chapter\s+\d+[\s\S]*$',
    r'^CHAPTER\s+\d+[\s\S]*$',
    # 其他格式
    r'^【第[零一二三四五六七八九十百千\d]+章】[\s\S]*$',
]
```

## 开发环境设置

### 环境要求
- Python 3.6+
- 标准库依赖：re, os, argparse, glob, logging, typing, datetime, hashlib

### 安装和测试
```bash
# 克隆项目
git clone <repository-url>
cd novel-splitter

# 运行测试
python fenli.py -a  # 批量处理测试
python fenli.py sample.txt -o test_output  # 单文件测试
```

## 扩展开发

### 添加新的章节模式

在 `__init__` 方法的 `chapter_patterns` 列表中添加新的正则表达式：

```python
self.chapter_patterns.append(r'^你的新章节模式$')
```

### 修改输出格式

重写 `generate_chapter_filename` 方法来自定义文件名生成逻辑：

```python
def generate_chapter_filename(self, title: str, index: int, metadata: Dict[str, str]) -> str:
    # 自定义文件名格式
    return f"{index:03d}_{title}.txt"
```

### 增强元数据提取

扩展 `extract_metadata` 方法来识别更多元数据类型：

```python
def extract_metadata(self, lines: List[str]) -> Dict[str, str]:
    metadata = super().extract_metadata(lines)
    # 添加新的元数据提取逻辑
    for line in lines[:50]:
        if '出版社' in line:
            metadata['publisher'] = line.strip()
    return metadata
```

## GitHub Actions 工作流

### 触发条件
- `push` 到包含 `.txt` 文件的提交
- 手动触发 (`workflow_dispatch`)

### 工作流程步骤
1. **环境设置** - 检出代码、设置Python环境
2. **目录准备** - 创建必要的输出目录
3. **文件处理** - 查找并处理所有txt文件
4. **结果整理** - 移动已处理文件，清理临时文件
5. **提交更改** - 自动提交分割后的章节文件

### 环境变量配置
需要在GitHub仓库Secrets中配置：
- `GIT_EMAIL` - Git提交邮箱
- `GIT_NAME` - Git提交用户名

## 测试和调试

### 日志系统
工具使用Python标准logging模块，支持：
- 控制台输出
- 文件日志（通过`--log`参数指定）
- 不同日志级别（INFO、WARNING、ERROR）

### 错误处理
- 文件编码检测失败时使用UTF-8回退
- 章节识别失败时尝试备用模式
- 重复内容自动跳过并记录警告

## 性能优化

### 内存管理
- 逐行读取大文件，避免内存溢出
- 使用生成器处理大型文件集合

### 处理效率
- 前500行模式检测，避免全文件扫描
- MD5哈希去重，快速识别重复内容

## 贡献指南

### 代码规范
- 使用类型注解（Type Hints）
- 遵循PEP 8编码规范
- 添加详细的文档字符串

### 提交信息
使用约定式提交格式：
- feat: 新功能
- fix: 修复问题
- docs: 文档更新
- refactor: 代码重构

## 故障排除

### 常见问题
1. **编码识别失败** - 检查文件实际编码，手动指定编码参数
2. **章节识别不准确** - 调整正则表达式模式或添加自定义模式
3. **内存不足** - 分块处理大文件，优化读取逻辑

### 调试模式
可以通过修改日志级别来启用详细调试：
```python
self.logger.setLevel(logging.DEBUG)
```

## 版本历史

### v1.0.0
- 基础章节分割功能
- 多格式章节识别
- GitHub Actions自动化
- 批量处理支持